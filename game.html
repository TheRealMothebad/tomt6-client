<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Turn Over More Than 6</title>
  <link rel="stylesheet" type="text/css" href="style.css" />
</head>

<body>
  <div class="color-picker-widget">
    <button class="color-btn" style="background-color: #A52A2A;" onclick="change_color('#A52A2A')"></button>
    <button class="color-btn" style="background-color: #228B22;" onclick="change_color('#228B22')"></button>
    <button class="color-btn" style="background-color: #DAA520;" onclick="change_color('#DAA520')"></button>
    <button class="color-btn" style="background-color: purple;" onclick="change_color('purple')"></button>
  </div>

  <h2>Turn Over More Than 6 Active Game</h2>
  <div class="controls-container">
    <button type="button" onclick="draw()">draw</button>
    <button type="button" onclick="fold()">fold</button>
  </div>

  <p id="action"></p>
  <div id="players-container">
  </div>

  <p id="not_pretty"></p> 
  <script>
    console.log("UUID from localStorage on game.html load:", localStorage.getItem("uuid"));
    let uuid = localStorage.getItem("uuid") || sessionStorage.getItem("uuid");
    if (!uuid) {
      const urlParams = new URLSearchParams(window.location.search);
      uuid = urlParams.get("uuid");
    }
    const socket = new WebSocket("wss://tomt6.umbriac.com/game");
    const message = JSON.stringify({"uuid": uuid});
    socket.onopen = () => {
      socket.send(message);
      socket.send(JSON.stringify({"action":"state"}));
    };

    socket.onmessage = (e) => {
      console.log("Received:", e);
      let parsed = JSON.parse(e.data);
      
      document.getElementById("action").textContent = generate_action_message(parsed.action, parsed.game);
      pretty_print(parsed.game, uuid);
      //document.getElementById("not_pretty").textContent = JSON.stringify(parsed);
    }

    function generate_action_message(action, game) {
      if (!action) {
        return "";
      }

      const actorName = game.players[action.actor] ? game.players[action.actor].name : "Unknown Player";

      switch (action.action) {
        case "draw":
          return `${actorName} drew the card ${fancy_name(action.card)}.`;
        case "fold":
          return `${actorName} folded.`;
        case "use":
          const targetName = game.players[action.target] ? game.players[action.target].name : "Unknown Player";
          return `${actorName} used ${fancy_name(action.card)} on ${targetName}.`;
        case "shuffle":
          return "The discard pile was shuffled into the deck.";
        default:
          return ``;
      }
    }

    function draw() {
      console.log("attempting draw");
      socket.send(JSON.stringify({"action":"draw"}));
    }
    function fold() {
      console.log("attempting fold");
      socket.send(JSON.stringify({"action":"fold"}));
    }
    function use(order_target) {
      console.log("use on", order_target);
      socket.send(JSON.stringify({"action":"use", "target":order_target}));
    }

    function change_color(color) {
      const isYouBox = document.querySelector('.is-you');
      if (isYouBox) {
        isYouBox.style.backgroundColor = color;
      }
    }

    function fancy_name(card) {
      switch(card) {
        case "f":
          return "freeze";
        case "d":
          return "draw three";
        case "s":
          return "second life";
      }
      return card;
    }


    function pretty_print(game, clientUuid) {
      const playersContainer = document.getElementById("players-container");
      playersContainer.innerHTML = ""; // Clear previous content

      for (const player of game.players) {
        const playerContainer = document.createElement("div");
        playerContainer.classList.add("player-box");

        const nameHeader = document.createElement("h3");
        let nameText = player.name;
        if (game.forced_draws && game.forced_draws[0] === player.order) {
          nameText += " <- Forced Draws";
          playerContainer.classList.add("current-turn");
        } else if (player.order === game.current_player) {
          nameText += " <- Current Player";
          playerContainer.classList.add("current-turn");
        }

        if (player.frozen || player.folded || player.lost) {
          nameHeader.classList.add("inactive-player");
        }

        if (player.uuid === clientUuid) {
          nameText = "(You) " + nameText;
          playerContainer.classList.add("is-you");
        }
        nameHeader.textContent = nameText;
        playerContainer.appendChild(nameHeader);

        const attributesP = document.createElement("p");
        attributesP.innerHTML = `
          Cards: ${player.cards.map(fancy_name).join(", ")}<br>
          Frozen: ${player.frozen}<br>
          Folded: ${player.folded}<br>
          Lost: ${player.lost}<br>
          Second Chances: ${player.second_chances}<br>
          Score: ${player.score}<br>
          Connected: ${player.connected}
        `;
        playerContainer.appendChild(attributesP);

        // Add the "Use on this player" button
        const useButton = document.createElement("button");
        useButton.textContent = `Use on ${player.name}`;
        useButton.onclick = () => use(player.order); // Call use function with player's order
        playerContainer.appendChild(useButton);

        playersContainer.appendChild(playerContainer);
      }


      document.getElementById("not_pretty").innerHTML = `
      discard pile: ${fancy_name(game.top_discard) ?? ""}<br>
      round number: ${game.round_number}
      `;
    }

  </script>
</body>
